<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSU Task Assignment System</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Poppins", sans-serif;
        }
        body {
            min-height: 100vh;
            background: #f4f7fa;
            color: #333;
            overflow-y: auto;
            transition: background 0.5s ease;
        }
        body.logged-in {
            background: linear-gradient(135deg, #bbdefb 0%, #e3f2fd 100%); /* Changed: reversed the gradient for a noticeable difference */
        }
        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px 5%;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            transition: background 0.5s ease;
        }
        body.logged-in .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .logo img {
            height: 80px; /* Increased logo size from 50px to 80px */
            width: auto; /* Maintain aspect ratio */
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        /* Rest of the CSS remains unchanged */
        .user-info {
            font-size: 14px;
            color: #555;
        }
        .user-info strong {
            color: #007bff;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            color: #fff;
            transition: background 0.3s;
        }
        .logout-btn {
            background: #dc3545;
        }
        .logout-btn:hover {
            background: #c82333;
        }
        .export-btn {
            background: #28a745;
        }
        .export-btn:hover {
            background: #218838;
        }
        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }
        .login-box {
            background: #fff;
            width: 400px;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
        }
        .login-box h2 {
            margin-bottom: 30px;
            color: #007bff;
            font-weight: 600;
        }
        .input-group {
            position: relative;
            margin-bottom: 25px;
        }
        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }
        .input-group input:focus {
            border-color: #007bff;
            outline: none;
        }
        .input-group label {
            position: absolute;
            left: 15px;
            top: 12px;
            color: #aaa;
            transition: 0.3s;
            pointer-events: none;
        }
        .input-group input:focus ~ label,
        .input-group input:valid ~ label {
            top: -10px;
            left: 10px;
            font-size: 12px;
            background: #fff;
            padding: 0 5px;
            color: #007bff;
        }
        .btn-login {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-login:hover {
            background: #0056b3;
        }
        /* Task Containers */
        .task-container {
            max-width: 900px;
            margin: 100px auto 50px;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            transition: all 0.5s ease;
        }
        body.logged-in .task-container {
            box-shadow: 0 10px 30px rgba(30, 100, 255, 0.15);
        }
        .task-container h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #007bff;
            font-weight: 600;
        }
        /* Employee Dashboard */
        .greeting {
            text-align: center;
            margin-bottom: 30px;
            font-size: 18px;
            color: #555;
        }
        .employee-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .summary-card {
            background: #f8fbff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 5px solid #007bff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .summary-card h3 {
            margin-bottom: 10px;
            color: #007bff;
        }
        .summary-card .value {
            font-size: 28px;
            font-weight: 600;
            color: #333;
        }
        .summary-card .pending { color: #ffc107; }
        .summary-card .completed { color: #28a745; }
        /* Forms and Tasks */
        form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        form input, form select, form textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        form input:focus, form select:focus, form textarea:focus {
            border-color: #007bff;
            outline: none;
        }
        form button {
            background: #007bff;
            color: #fff;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }
        form button:hover {
            background: #0056b3;
        }
        .task-list {
            list-style: none;
        }
        .task-item {
            background: #f8fbff;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 5px solid #007bff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        .task-item:hover {
            box-shadow: 0 5px 15px rgba(0,123,255,0.1);
            transform: translateY(-2px);
        }
        .task-content .task-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .task-description {
            color: #666;
            margin-bottom: 8px;
        }
        .task-date {
            font-size: 13px;
            color: #888;
            margin-bottom: 8px;
        }
        .task-status {
            font-size: 13px;
            font-weight: 500;
        }
        .task-status.completed {
            color: #28a745;
        }
        .task-actions label {
            margin-left: 8px;
            font-size: 14px;
        }
        .no-tasks {
            text-align: center;
            color: #888;
            font-style: italic;
            padding: 20px;
        }
        /* Admin Stats */
        .stats-section {
            margin-bottom: 40px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .stat-card {
            background: #f8fbff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 5px solid #007bff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .stat-card h3 {
            margin-bottom: 10px;
            color: #007bff;
        }
        .stat-card .value {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }
        .stat-card .accuracy { color: #28a745; }
        @media (max-width: 768px) {
            .task-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .task-actions {
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- The HTML structure and JavaScript remain exactly the same as the previous version -->
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <a href="https://nsusolutions.com/" target="_blank">
                <img src="https://nsusolutions.com/images/logo.png" alt="NSU Secure Solutions Logo">
            </a>
        </div>
        <div class="header-right">
            <div class="user-info" id="user-info" style="display:none;">
                Logged in as: <strong id="current-user"></strong>
            </div>
            <button class="btn export-btn" id="export-btn" style="display:none;" onclick="exportToExcel()">Export to Excel</button>
            <button class="btn logout-btn" id="logout-btn" style="display:none;">Logout</button>
        </div>
    </div>

    <!-- Login Page -->
    <div class="login-container" id="login-page">
        <div class="login-box">
            <h2>NSU Task Manager</h2>
            <form id="login-form">
                <div class="input-group">
                    <input type="email" id="login-email" required>
                    <label>Email</label>
                </div>
                <div class="input-group">
                    <input type="password" id="login-password" required>
                    <label>Password</label>
                </div>
                <button type="submit" class="btn-login">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="task-container" id="admin-container" style="display:none;">
        <h1>Admin Panel - Assign Tasks</h1>
        
        <div class="stats-section" id="employee-stats"></div>

        <form id="assign-task-form">
            <label for="employee-select">Select Employee</label>
            <select id="employee-select" required>
                <option value="">Choose Employee</option>
                <option value="venkat@nsusolutions.com">Venkat</option>
                <option value="sakthi@nsusolutions.com">Sakthi</option>
            </select>
            <label for="task-title">Task Title</label>
            <input type="text" id="task-title" required>
            <label for="task-description">Task Description</label>
            <textarea id="task-description" rows="4" required></textarea>
            <button type="submit">Assign Task</button>
        </form>

        <h2>All Assigned Tasks</h2>
        <ul class="task-list" id="admin-task-list"></ul>
    </div>

    <!-- Employee Dashboard -->
    <div class="task-container" id="employee-container" style="display:none;">
        <div class="greeting" id="employee-greeting"></div>
        
        <div class="employee-dashboard">
            <div class="summary-card">
                <h3>Total Tasks</h3>
                <div class="value" id="total-tasks">0</div>
            </div>
            <div class="summary-card">
                <h3>Pending</h3>
                <div class="value pending" id="pending-tasks">0</div>
            </div>
            <div class="summary-card">
                <h3>Completed</h3>
                <div class="value completed" id="completed-tasks">0</div>
            </div>
            <div class="summary-card">
                <h3>Completion Rate</h3>
                <div class="value completed" id="completion-rate">0%</div>
            </div>
        </div>

        <h1 style="text-align:center; margin-bottom:20px;">My Assigned Tasks</h1>
        <ul class="task-list" id="task-list"></ul>
    </div>

    <script type="module">
        // JavaScript remains unchanged from the previous version
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB0VyfkS5-hulqF4gyVkoc1R4ZJxfVf0wg",
            authDomain: "nsu-task.firebaseapp.com",
            projectId: "nsu-task",
            storageBucket: "nsu-task.firebasestorage.app",
            messagingSenderId: "881478545482",
            appId: "1:881478545482:web:e6f8d21fbc5dc2078db6b3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN_EMAIL = "admin@nsusolutions.com".toLowerCase();

        const emailToName = {
            "admin@nsusolutions.com": "Admin",
            "venkat@nsusolutions.com": "Venkat",
            "sakthi@nsusolutions.com": "Sakthi"
        };

        let allTasks = [];
        let currentUserEmail = null;
        let currentUserName = null;

        function getNameFromEmail(email) {
            return emailToName[email.toLowerCase()] || email.split('@')[0].charAt(0).toUpperCase() + email.split('@')[0].slice(1);
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return "Unknown";
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) +
                   ' at ' +
                   date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        }

        // Admin: Display stats
        function displayEmployeeStats() {
            const container = document.getElementById('employee-stats');
            container.innerHTML = '';
            const statsMap = {};
            allTasks.forEach(task => {
                const emp = task.assignedTo;
                if (!statsMap[emp]) statsMap[emp] = { total: 0, completed: 0 };
                statsMap[emp].total++;
                if (task.completed) statsMap[emp].completed++;
            });

            const employeeEmails = ["venkat@nsusolutions.com", "sakthi@nsusolutions.com"];
            employeeEmails.forEach(empEmail => {
                const name = getNameFromEmail(empEmail);
                const s = statsMap[empEmail.toLowerCase()] || { total: 0, completed: 0 };
                const accuracy = s.total > 0 ? Math.round((s.completed / s.total) * 100) : 0;
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <h3>${name}'s Performance</h3>
                    <p>Total Tasks: <span class="value">${s.total}</span></p>
                    <p>Completed: <span class="value completed">${s.completed}</span></p>
                    <p>Completion Rate: <span class="value accuracy">${accuracy}%</span></p>
                `;
                container.appendChild(card);
            });
        }

        // Admin: Display all tasks
        function displayAdminTasks() {
            const taskList = document.getElementById('admin-task-list');
            taskList.innerHTML = '';
            if (allTasks.length === 0) {
                taskList.innerHTML = '<li class="no-tasks">No tasks assigned yet.</li>';
                return;
            }
            allTasks.forEach(task => {
                const li = document.createElement('li');
                li.className = 'task-item';
                const statusClass = task.completed ? 'completed' : '';
                const statusText = task.completed ? 'Completed' : 'Pending';
                const assignedName = getNameFromEmail(task.assignedTo);
                const assignedDate = formatDateTime(task.assignedAt);
                li.innerHTML = `
                    <div class="task-content">
                        <div class="task-title">${task.title} (Assigned to: ${assignedName})</div>
                        <div class="task-description">${task.description}</div>
                        <div class="task-date">Assigned on: ${assignedDate}</div>
                        <div class="task-status ${statusClass}">${statusText}</div>
                    </div>
                `;
                taskList.appendChild(li);
            });
        }

        // Employee: Display my tasks
        function displayMyTasks(snapshot) {
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = '';
            const docs = snapshot.docs;
            let completedCount = 0;
            docs.forEach(docSnap => {
                const task = { id: docSnap.id, ...docSnap.data() };
                if (task.completed) completedCount++;
                const li = document.createElement('li');
                li.className = 'task-item';
                const assignedDate = formatDateTime(task.assignedAt);
                li.innerHTML = `
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        <div class="task-description">${task.description}</div>
                        <div class="task-date">Assigned on: ${assignedDate}</div>
                    </div>
                    <div class="task-actions">
                        <input type="checkbox" ${task.completed ? 'checked' : ''}>
                        <label>Mark as Completed</label>
                    </div>
                `;
                const checkbox = li.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', () => {
                    const taskRef = doc(db, "tasks", task.id);
                    updateDoc(taskRef, { completed: checkbox.checked });
                });
                taskList.appendChild(li);
            });
            const total = docs.length;
            const pending = total - completedCount;
            const rate = total > 0 ? Math.round((completedCount / total) * 100) : 0;
            document.getElementById('total-tasks').textContent = total;
            document.getElementById('pending-tasks').textContent = pending;
            document.getElementById('completed-tasks').textContent = completedCount;
            document.getElementById('completion-rate').textContent = rate + '%';

            if (docs.length === 0) {
                taskList.innerHTML = '<li class="no-tasks">No tasks assigned yet.</li>';
            }
        }

        // Load all tasks (admin)
        function loadAllTasks() {
            const q = query(collection(db, "tasks"), orderBy("assignedAt", "desc"));
            onSnapshot(q, snapshot => {
                allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayAdminTasks();
                displayEmployeeStats();
            });
        }

        // Load my tasks (employee)
        function loadMyTasks(email) {
            const q = query(collection(db, "tasks"), where("assignedTo", "==", email), orderBy("assignedAt", "desc"));
            onSnapshot(q, snapshot => {
                displayMyTasks(snapshot);
            });
        }

        // Assign task
        document.getElementById('assign-task-form').addEventListener('submit', async e => {
            e.preventDefault();
            const employeeEmail = document.getElementById('employee-select').value.toLowerCase();
            const title = document.getElementById('task-title').value.trim();
            const description = document.getElementById('task-description').value.trim();
            if (!employeeEmail || !title || !description) {
                alert('Please fill all fields');
                return;
            }
            try {
                await addDoc(collection(db, "tasks"), {
                    title,
                    description,
                    assignedTo: employeeEmail,
                    assignedAt: serverTimestamp(),
                    completed: false
                });
                alert('Task assigned successfully!');
                e.target.reset();
            } catch (err) {
                alert('Error assigning task: ' + err.message);
            }
        });

        // Login
        document.getElementById('login-form').addEventListener('submit', async e => {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim().toLowerCase();
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (err) {
                alert('Login failed: ' + err.message);
            }
        });

        // Auth state
        onAuthStateChanged(auth, async user => {
            if (!user) {
                document.body.classList.remove('logged-in');
                document.getElementById('login-page').style.display = 'flex';
                document.getElementById('admin-container').style.display = 'none';
                document.getElementById('employee-container').style.display = 'none';
                document.getElementById('user-info').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'none';
                document.getElementById('export-btn').style.display = 'none';
                document.getElementById('login-form').reset();
                return;
            }

            currentUserEmail = user.email.toLowerCase();
            currentUserName = getNameFromEmail(currentUserEmail);

            document.body.classList.add('logged-in');
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('current-user').textContent = currentUserName;
            document.getElementById('user-info').style.display = 'block';
            document.getElementById('logout-btn').style.display = 'block';

            if (currentUserEmail === ADMIN_EMAIL) {
                document.getElementById('admin-container').style.display = 'block';
                document.getElementById('employee-container').style.display = 'none';
                document.getElementById('export-btn').style.display = 'block';
                loadAllTasks();
            } else {
                if (!emailToName[currentUserEmail]) {
                    alert('Unauthorized user');
                    await signOut(auth);
                    return;
                }
                const hour = new Date().getHours();
                let greeting = 'Good ';
                if (hour < 12) greeting += 'Morning';
                else if (hour < 18) greeting += 'Afternoon';
                else greeting += 'Evening';
                document.getElementById('employee-greeting').textContent = `${greeting}, ${currentUserName}!`;

                document.getElementById('admin-container').style.display = 'none';
                document.getElementById('employee-container').style.display = 'block';
                document.getElementById('export-btn').style.display = 'none';
                loadMyTasks(currentUserEmail);
            }
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await signOut(auth);
        });

        // Export to Excel (admin only)
        window.exportToExcel = function() {
            if (allTasks.length === 0) {
                alert("No tasks to export!");
                return;
            }
            const exportData = allTasks.map(task => ({
                Employee: getNameFromEmail(task.assignedTo),
                "Task Title": task.title,
                Description: task.description,
                "Assigned On": formatDateTime(task.assignedAt),
                Status: task.completed ? "Completed" : "Pending"
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Tasks");
            ws['!cols'] = [{ wch: 15 }, { wch: 25 }, { wch: 40 }, { wch: 25 }, { wch: 12 }];
            XLSX.writeFile(wb, "NSU_Task_Report_" + new Date().toISOString().slice(0,10) + ".xlsx");
            alert("Excel report downloaded successfully!");
        }
    </script>
</body>
</html>
